---
title: 咨询服务迁入中台项目总结
categories: 项目总结
description: 崩溃的一周总结= =
date: 2020-01-18 21:42:48
tags:
---

# 前言
这周发布了我来到新公司写的第一个项目，出现了很多我没有想到的问题也导致了后续的疯狂加班。我觉得有必要记录一下，以后每完成一个项目都应该有所总结。

# 问题与反思
## 1.患者排队问题
### 现象
项目发布当晚所有进入排队状态的患者，至第二日早上空闲了也没有分配医助进行处理。在问题解决前有约50名患者受到了影响，其中大部分还是腾讯渠道的付费患者。
### 原因
发布前两日，额外增加了新的两个渠道，然而我并不知情。最后导致代码的枚举转换对应不上，直接扔出异常，影响了所有排队的用户。
### 反思
这个问题其实是一个非常严重的线上问题，幸好现场的医助没有向上反馈，否则真的就翻车了。
之前修改这一块的时候，想着在会话排队这一块所有渠道都是一样的不需要做特殊处理，就让所有渠道都走重构的代码了。但万万没有考虑到，如果后续新加了渠道，会扔出异常的问题。其实这也是自己设计的问题，代码应该是要遵循"开闭原则"，不能让新增的东西去影响我整个核心业务的走势。

## 2.项目发布前一小时才发现线上有部分数据有问题
### 现象
线上有部分医助没有手机号，导致新写的脚本将无法为他们刷新doctorId，会影响到重构的代码所有的逻辑。最后手忙脚乱，临时改代码生成虚拟手机号。
### 反思
其实这个问题在很早之前我就知道有了，但是因为同事说没手机号的人之后再记录，反馈给产品。就没有当回事了，但其实这个是会影响到主流程的，当时没有太当回事，临了上线才注意到这个问题的严重性，已经来不及找产品了。以后的话，不要把东西都太想当然了，很多细节是必须要注意的。

## 3.部分患者发送的消息绕开医助直接到医生
### 现象
发布第二日，有同事发现部分腾讯患者没有通过医助就直接被系统分配给了医生，这是不符合我们的分配原则的。
### 原因
代码逻辑中会有分配给上一次沟通过的医助。而我对这块业务其实并不知情，重构都是看以前的代码进行调整的，最终导致sql语句有漏洞。
### 反思
这个问题真的是我自己导致的，不过因为触发条件比较苛刻，所以对于线上的影响并不大。但是这个问题理应在上线前就被发现。究其根本原因还是我写的单元测试没有覆盖好，因为当时处理消息要考虑的分支实在是太多了，我个人觉得这一块是比较简单的不会出什么问题。然而正是这些没覆盖到的单元测试出现了问题。

## 4.重构完成后新增自有渠道需要改的代码很多
### 现象
现在在做视频服务咨询，又新接入了一个魔镜的自有渠道。发现因为中台那里没有接入这个渠道，所以得通知他们加渠道，其次自身所有转换类都要把这个渠道加上

### 原因
这个问题很明显就是代码违反了"开闭原则"，其实整个咨询服务重构就是为了解决这个问题，于是采用了SPI的方法。因为我自己当时接手这个项目也是刚刚进入公司，对业务什么的都不是很了解，听了TD，似懂非懂的就开始写代码了，但没有考虑过他们为什么要这么设计，最终导致有部分代码有点坏味道。

### 反思
写代码前应该要充分的考量和设计，而不是写到哪设计到哪。我觉得这就是所谓码农和软件开发工程师最大的区别了。后续有时间，我应该自己把代码再优化一下，使得后续新增渠道，对核心代码没有任何影响才算合格。

# 解决方案
## 针对单元测试
写单元测试时可以用一个场景图把业务点都列出来。比如会话分配的业务点1，业务点2，各个业务点再细分最终要落到要设置哪些字段对应的业务效果是什么。比如值班消息需要返回reply字段，会影响提示音发送，那么我的单元测试就应该在最后检查这个字段的值。

明明写了很多单元测试最后还是发现少考虑了，就是因为自己都没理清楚有哪些业务点，其次也是自己懒了，不想去mock那么多数据。

## 针对代码设计
以后一定要**先做代码设计，再写代码**，要做到"以终为始"。

具体做法的话，完全可以在写代码前，把整个代码的骨架搭好，里面可以先用空实现以及TODO，等架构搭好了以后，自己评估或者找人帮忙评估。最后再一步步去实现里面的代码。

## 针对自己
这个项目是我来公司的第一个项目，用时一个多月，时间其实是非常宽裕的，也不是很忙。但是最后上线还是出现了这么多问题，只能说我自己有很大的问题。

首先是自己对公司业务还不是很熟悉，毕竟刚来，他们讲的很多东西我都听得很懵。这个没有人能帮自己，必须要自己去主动了解，多使用下自己的产品。

接着是自己的沟通，项目讨论的时候，可能也是因为自己的不自信吧，想问的每句话都会在心里想好再说出来，怕说的东西太幼稚，被其他人鄙视= = 但是正是因为自己的顾虑太多，说的就更少了，许多有疑问和质疑的地方就应该提出来。

最后是承担，很奇怪，当线上出现BUG的时候我的第一反应是去想这个会不会和我有关，和我有关的话该怎么甩锅。是自己的问题就是自己的问题，没什么好推脱的，而且同组的其他人真的都很认真负责，对线上的BUG都是第一时间去查的。还有很多恶心的现象，我自己嫌麻烦，看到有人在跟进了，自己就不管了，其实是知道那些现象可能是和自己有关的。承担的品格无论在工作中还是生活中我都应该不能去忘记。

# 总结
这一周过得很不开心，也很累。经历了发布项目的通宵，疯狂加班，后续处理线上问题与紧急的新需求搞得自己心力交瘁。说实话，互联网公司的压力似乎比我想象的要大，尤其是当我看到因为自己代码报错导致耽搁的患者聊天记录里质问我们回复效率咋那么低的时候，我当时真的快疯了，这和之前在传统行业开发的感觉是不一样的，QA只是负责大致验收下产品主流程能不能通，具体的产品质量应该是研发去负责的。我甚至开始怀疑自己是不是不应该进入互联网行业的圈子，但是我总得试一试不是么。希望这段时间过后，一切都能变好吧。Best Wish！
